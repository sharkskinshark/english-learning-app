<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-touch-fullscreen" content="yes" />
  <meta name="format-detection" content="telephone=no" />
  <meta name="theme-color" content="#2b8cf3" />
  <!-- Eliminate 300ms delay on mobile -->
  <style>
    html { -ms-touch-action: manipulation; touch-action: manipulation; }
    * { -ms-touch-action: manipulation; touch-action: manipulation; }
  </style>
  <title>Cambridge Vocabulary Practice</title>
  <link rel="stylesheet" href="styles.css">
  <!-- Vercel Speed Insights for vanilla HTML/JS apps -->
  <script>
    window.si = window.si || function () { (window.siq = window.siq || []).push(arguments); };
  </script>
  <script defer src="/_vercel/speed-insights/script.js"></script>
  <!-- Alternative CDN version for GitHub Pages compatibility -->
  <script defer src="https://va.vercel-scripts.com/v1/speed-insights/script.js"></script>
  <!-- Custom performance tracking for GitHub Pages -->
  <script>
    // Track Core Web Vitals manually
    function trackWebVitals() {
      // Track page load time
      window.addEventListener('load', () => {
        const loadTime = performance.now();
        console.log('📊 Page Load Time:', Math.round(loadTime), 'ms');
        
        // Track if Speed Insights is working
        if (window.si) {
          console.log('✅ Vercel Speed Insights loaded');
          // Send a test event to Speed Insights
          window.si('event', 'page_view', {
            device: /Mobile|Android|iPhone|iPad/.test(navigator.userAgent) ? 'mobile' : 'desktop',
            timestamp: new Date().toISOString()
          });
        } else {
          console.log('⚠️ Speed Insights not available');
        }
        
        // Track device type for debugging
        const isMobile = /Mobile|Android|iPhone|iPad/.test(navigator.userAgent);
        console.log('📱 Device Type:', isMobile ? 'Mobile' : 'Desktop');
        console.log('🌐 User Agent:', navigator.userAgent);
      });
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', trackWebVitals);
    } else {
      trackWebVitals();
    }
  </script>
</head>
<body>
  <!-- Halloween Loading Animation (only on 2025/10/31) -->
  <div id="halloweenLoader" class="halloween-loader">
    <div class="halloween-emoji" data-emoji="🎃" data-corner="top-left"></div>
    <div class="halloween-emoji" data-emoji="👻" data-corner="top-right"></div>
    <div class="halloween-emoji" data-emoji="🦇" data-corner="bottom-left"></div>
    <div class="halloween-emoji" data-emoji="🕷️" data-corner="bottom-right"></div>
    <div class="halloween-emoji" data-emoji="🕸️" data-corner="center-left"></div>
    <div class="halloween-emoji" data-emoji="💀" data-corner="center-right"></div>
    <div class="halloween-center-text">🎃 Happy Halloween! 🎃</div>
  </div>

  <main class="container" id="mainContent">
    <h1>Cambridge Vocabulary Practice</h1>
    <h2>Improve your Listening, Spelling and Understanding</h2>

    <section class="controls">
      <label>Mode:
        <select id="modeSelect">
          <option value="spelling">Spelling (type the word)</option>
          <option value="meaning">Meaning (pick the right meaning)</option>
          <option value="phonics">Phonics Helper</option>
        </select>
      </label>

      <label>Mode:
        <select id="practiceMode">
          <option value="learn">Learn New Words</option>
          <option value="review">Review Mode</option>
        </select>
      </label>

      <div id="learnControls">
        <label>Level:
          <select id="levelSelect">
            <option value="starters">Starters (Beginner)</option>
            <option value="movers">Movers (Elementary)</option>
            <option value="flyers">Flyers (Pre-Intermediate)</option>
          </select>
        </label>

        <label>Category:
          <select id="categorySelect"><option value="">Loading categories...</option></select>
        </label>
      </div>

      <button id="startBtn">Start Practice</button>
      <div id="loadingMessage">Loading vocabulary...</div>
      <button id="listenBtn" style="display:none">🔊 Listen to Word</button>
      
      <div id="reviewStats" class="review-stats hidden">
        <span>Words to Review: <span id="reviewCount">0</span></span>
        <span>Mastered: <span id="masteredCount">0</span></span>
      </div>
    </section>

    <section id="exercise" class="exercise hidden">
      <div id="progress" class="progress">0 / 0</div>
      <div id="prompt" class="prompt">Press Start to begin</div>

      <div id="spellingArea" class="mode-area">
        <div class="listen-spell">
          <button id="listenWordBtn" class="icon-btn">🔊 Listen to Word</button>
          <input id="spellingInput" placeholder="Type what you hear..." autocomplete="off">
          <button id="submitSpelling" class="btn">Check Answer</button>
        </div>
        <div id="spellingResult" class="hidden">
          <p id="resultMessage"></p>
          <div id="correctAnswer" class="hidden">
            <p>Correct spelling: <span id="correctSpelling"></span></p>
            <div id="wordImage" class="word-image"></div>
          </div>
        </div>
      </div>

      <div id="meaningArea" class="mode-area hidden">
        <div class="word-row">
          <span id="wordDisplay"></span>
          <button id="pronounceBtn" class="icon-btn" title="Listen to pronunciation">🔊</button>
        </div>
        <div id="choices" class="choices"></div>
      </div>

      <div id="phonicsArea" class="mode-area hidden">
        <div class="word-row">
          <span id="phonicsWordDisplay" class="word-display"></span>
          <button id="phonicsPronounceBtn" class="icon-btn" title="Listen to pronunciation">🔊</button>
        </div>
        <div id="phonicsHelperContainer"></div>
      </div>

      <div id="feedback" class="feedback"></div>
      <div class="controls-row">
        <button id="nextBtn" class="hidden">Next</button>
        <button id="restartBtn" class="hidden">Restart</button>
      </div>

      <div id="score" class="score hidden">Score: 0</div>
    </section>

    <section id="eventSection" class="event-section hidden">
      <h2 id="eventTitle">Special Event 🎉</h2>
      <div class="event-content">
        <div id="eventWords" class="event-words"></div>
        <div id="eventChallenges" class="event-challenges"></div>
      </div>
    </section>

    <section id="dailySection" class="daily-section">
      <h2>Daily Challenges 📅</h2>
      <div class="daily-streak">
        <span>Streak: <span id="currentStreak">0</span> days</span>
        <span>Best: <span id="bestStreak">0</span> days</span>
      </div>
      <div id="dailyChallenges" class="daily-challenges"></div>
    </section>

    <section id="calendarSection" class="calendar-section">
      <h2>Practice Calendar 📆</h2>
      <div id="calendarView" class="calendar-view"></div>
    </section>

    <section id="leaderboardsSection" class="leaderboards-section">
      <h2>Leaderboards 🏆</h2>
      <div class="username-area">
        <input type="text" id="usernameInput" placeholder="Enter your name" maxlength="20">
        <button id="saveUsername">Save Name</button>
      </div>
      <div id="leaderboardsContent" class="leaderboards-content"></div>
    </section>

    <section id="progressSection" class="progress-section hidden">
      <h2>Your Progress & Achievements 🏆</h2>
      <div class="progress-grid">
        <div class="progress-card" data-level="starters">
          <h3>Starters 🌱</h3>
          <div class="progress-details"></div>
        </div>
        <div class="progress-card" data-level="movers">
          <h3>Movers 🚶</h3>
          <div class="progress-details"></div>
        </div>
        <div class="progress-card" data-level="flyers">
          <h3>Flyers 🦋</h3>
          <div class="progress-details"></div>
        </div>
      </div>

      <div class="achievements-section">
        <h3>Your Achievements</h3>
        <div class="achievements-grid" id="achievementsGrid"></div>
      </div>
      
      <button id="showProgress">Show Progress</button>
    </section>

    <footer class="notes">
      For elementary kids: Start with Starters level. Encourage spelling slowly.
      <div class="reset-section">
        <button id="resetAppBtn" class="reset-btn">🔄 Reset App</button>
      </div>
    </footer>
  </main>

  <script src="achievements.js?v=3"></script>
  <script src="review.js?v=3"></script>
  <script src="daily.js?v=3"></script>
  <script src="events.js?v=3"></script>
  <script src="app.js?v=3"></script>
  <script src="calendar.js?v=3"></script>
  <script src="leaderboard.js?v=3"></script>

  <!-- Achievement notification template -->
  <div id="achievementNotif" class="achievement-unlock hidden">
    <div class="achievement-emoji"></div>
    <div class="achievement-title"></div>
  </div>

  <!-- Kiwi character - clickable element -->
  <div class="kiwi-character" id="kiwiCharacter"></div>

  <!-- Kiwi Tooltip - Two stages -->
  <div id="kiwiTooltip">
    <div id="kiwiStage1" class="tooltip-stage active">
      Hey, I'm Kiwi. A Second Grade student in the Elementary School in Taipei City, Taiwan. OCT.2025
    </div>
    <div id="kiwiStage2" class="tooltip-stage">
      1. Select the first Mode Box, then the second Mode Box.<br>
      2. Choose Level, then Category.<br>
      3. Press "Start Practice" Blue Button.<br>
      4. Press "Listen to Word" White Button.<br>
      5. Type in your spelling text, press "Check Answer" Blue Button.<br>
      6. Press "Next" Blue Button for next Vocabulary.<br><br>
      Press anywhere on the screen to exit the instruction and start test.
    </div>
  </div>

  <script>
    // Kiwi character hover handler - two-stage tooltip with mobile support
    function setupKiwiHover() {
      const kiwiCharacter = document.getElementById('kiwiCharacter');
      const tooltip = document.getElementById('kiwiTooltip');
      const stage1 = document.getElementById('kiwiStage1');
      const stage2 = document.getElementById('kiwiStage2');
      let stageTimeout;
      let isTooltipVisible = false;
      let isMobile = false;
      
      // Detect if device is mobile/tablet
      function detectMobile() {
        const userAgent = navigator.userAgent || navigator.vendor || window.opera;
        const isMobileUA = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
        const isSmallScreen = window.innerWidth <= 768;
        const hasTouchScreen = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        
        const result = isMobileUA || isSmallScreen || hasTouchScreen;
        console.log('🔍 Device detection:', {
          userAgent: userAgent.substring(0, 50) + '...',
          isMobileUA,
          isSmallScreen,
          hasTouchScreen,
          screenSize: window.innerWidth + 'x' + window.innerHeight,
          result
        });
        
        return result;
      }
      
      // Check if elements exist
      if (!kiwiCharacter || !tooltip || !stage1 || !stage2) {
        console.error('❌ Kiwi elements not found!');
        return;
      }
      
      isMobile = detectMobile();
      console.log('✅ Kiwi two-stage tooltip initialized', isMobile ? '(Mobile Mode)' : '(Desktop Mode)');
      
      function showKiwiTooltip() {
        console.log('🚀 showKiwiTooltip called');
        
        // Clear any existing timeout
        if (stageTimeout) {
          clearTimeout(stageTimeout);
        }
        
        // Reset to stage 1
        stage1.classList.add('active');
        stage2.classList.remove('active');
        console.log('📝 Stage 1 activated, Stage 2 deactivated');
        
        // Adjust tooltip size for mobile and iPad with viewport-based positioning
        if (isMobile) {
          const screenWidth = window.innerWidth;
          const screenHeight = window.innerHeight;
          const isIPad = /iPad|Macintosh/i.test(navigator.userAgent) && 'ontouchend' in document;
          const isSafari = /Safari/i.test(navigator.userAgent) && !/Chrome|CriOS|Edge|Edg/i.test(navigator.userAgent);
          
          console.log('📱 Screen dimensions:', screenWidth, 'x', screenHeight);
          console.log('📱 Device detection - iPad:', isIPad, 'Safari:', isSafari);
          
          // Calculate safe dimensions
          const safeWidth = Math.min(screenWidth - 30, 400);
          const safeHeight = screenHeight - 60;
          
          // Reset any previous inline styles
          tooltip.style.maxWidth = safeWidth + 'px';
          tooltip.style.maxHeight = safeHeight + 'px';
          tooltip.style.position = 'fixed';
          tooltip.style.margin = '0';
          tooltip.style.zIndex = '1002';
          
          // iPad-specific viewport positioning fixes
          if (isIPad && isSafari) {
            console.log('📱 Applying iPad Safari viewport fixes');
            // Use JavaScript to calculate exact center position for iPad
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            tooltip.style.top = '50vh';
            tooltip.style.left = '50vw';
            tooltip.style.transform = 'translate(-50%, -50%)';
            tooltip.style.webkitTransform = 'translate(-50%, -50%)';
            
            // Force recalculation after a brief delay for iPad Safari
            setTimeout(() => {
              const centerX = viewportWidth / 2;
              const centerY = viewportHeight / 2;
              
              tooltip.style.top = centerY + 'px';
              tooltip.style.left = centerX + 'px';
              tooltip.style.transform = 'translate(-50%, -50%)';
              tooltip.style.webkitTransform = 'translate(-50%, -50%)';
              
              console.log('📱 iPad: Forced pixel positioning -', centerX, centerY);
            }, 50);
          } else {
            // Standard viewport positioning for other mobile devices
            tooltip.style.top = '50vh';
            tooltip.style.left = '50vw';
            tooltip.style.transform = 'translate(-50%, -50%)';
          }
          
          console.log('📱 Tooltip size adjusted for mobile:', safeWidth, 'x', safeHeight);
        } else {
          // Desktop - reset to CSS defaults
          tooltip.style.maxWidth = '';
          tooltip.style.maxHeight = '';
          tooltip.style.position = '';
          tooltip.style.top = '';
          tooltip.style.left = '';
          tooltip.style.transform = '';
          tooltip.style.margin = '';
          console.log('🖥️ Tooltip reset for desktop');
        }
        
        // Show tooltip
        tooltip.classList.add('show');
        isTooltipVisible = true;
        console.log('🥝 Tooltip show class added, isTooltipVisible:', isTooltipVisible);
        console.log('🎭 Tooltip element:', tooltip);
        console.log('🎭 Tooltip classes:', tooltip.className);
        
        // Start heartbeat animation
        kiwiCharacter.classList.add('mobile-heartbeat');
        console.log('💓 Heartbeat animation started, classes:', kiwiCharacter.className);
        
        // Transition to stage 2 after 3 seconds
        stageTimeout = setTimeout(() => {
          stage1.classList.remove('active');
          stage2.classList.add('active');
          console.log('🥝 Stage 2: Instructions shown');
        }, 3000);
        
        console.log('⏰ Stage 2 timeout set for 3 seconds');
      }
      
      function hideKiwiTooltip() {
        tooltip.classList.remove('show');
        isTooltipVisible = false;
        kiwiCharacter.classList.remove('mobile-heartbeat');
        console.log('💓 Heartbeat animation stopped, classes:', kiwiCharacter.className);
        
        if (stageTimeout) {
          clearTimeout(stageTimeout);
        }
        // Reset to stage 1 for next time
        setTimeout(() => {
          stage1.classList.add('active');
          stage2.classList.remove('active');
        }, 300);
        console.log('🥝 Tooltip hidden, heartbeat stopped, reset to stage 1');
      }
      
      if (isMobile) {
        console.log('📱 Setting up mobile/tablet interactions');
        
        // Mobile/Tablet behavior - click to show/hide
        kiwiCharacter.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          console.log('📱 Mobile: Kiwi clicked, current tooltip visible:', isTooltipVisible);
          
          if (isTooltipVisible) {
            hideKiwiTooltip();
            console.log('📱 Mobile: Hiding tooltip');
          } else {
            showKiwiTooltip();
            console.log('📱 Mobile: Showing tooltip immediately');
          }
        });
        
        // Touch start for immediate feedback
        kiwiCharacter.addEventListener('touchstart', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('📱 Mobile: Touch started');
        }, { passive: false });
        
        // Touch end for better responsiveness (especially iPad)
        kiwiCharacter.addEventListener('touchend', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          console.log('📱 Mobile: Touch ended, current tooltip visible:', isTooltipVisible);
          
          // Small delay to ensure click event doesn't interfere
          setTimeout(() => {
            if (!isTooltipVisible) {
              showKiwiTooltip();
              console.log('📱 Mobile: Touch end - showing tooltip');
            }
          }, 50);
        }, { passive: false });
        
        // Click anywhere else to hide tooltip
        document.addEventListener('click', function(e) {
          if (isTooltipVisible && e.target !== kiwiCharacter && !kiwiCharacter.contains(e.target) && !tooltip.contains(e.target)) {
            hideKiwiTooltip();
            console.log('� Mobile: Clicked elsewhere - hiding tooltip');
          }
        });
        
      } else {
        // Desktop behavior - hover to show/hide
        kiwiCharacter.addEventListener('mouseenter', function(e) {
          showKiwiTooltip();
          console.log('🖱️ Desktop: Mouse entered Kiwi - starting two-stage tooltip');
        });
        
        kiwiCharacter.addEventListener('mouseleave', function(e) {
          hideKiwiTooltip();
          console.log('🖱️ Desktop: Mouse left Kiwi - hiding tooltip');
        });
      }
      
      // Update mobile detection on resize
      window.addEventListener('resize', function() {
        const wasMobile = isMobile;
        isMobile = detectMobile();
        if (wasMobile !== isMobile) {
          console.log('📱 Device mode changed:', isMobile ? 'Mobile' : 'Desktop');
          // Remove existing event listeners and re-setup if needed
          hideKiwiTooltip();
        }
      });
    }

    // Initialize when page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupKiwiHover);
    } else {
      setupKiwiHover();
    }

    // Floating scroll detection for enhanced visual feedback
    function setupFloatingFeedback() {
      const kiwiCharacter = document.getElementById('kiwiCharacter');
      const tooltip = document.getElementById('kiwiTooltip');
      let scrollTimeout;
      let isScrolling = false;

      function handleScroll() {
        if (!isScrolling) {
          // Start floating animation
          if (kiwiCharacter) {
            kiwiCharacter.classList.add('floating');
          }
          if (tooltip && tooltip.classList.contains('show')) {
            tooltip.classList.add('floating');
          }
          isScrolling = true;
        }

        // Clear previous timeout
        clearTimeout(scrollTimeout);

        // Stop floating animation after scroll ends
        scrollTimeout = setTimeout(() => {
          if (kiwiCharacter) {
            kiwiCharacter.classList.remove('floating');
          }
          if (tooltip) {
            tooltip.classList.remove('floating');
          }
          isScrolling = false;
        }, 150); // Stop animation 150ms after scroll ends
      }

      // Add scroll event listener with throttling for performance
      let ticking = false;
      window.addEventListener('scroll', function() {
        if (!ticking) {
          requestAnimationFrame(function() {
            handleScroll();
            ticking = false;
          });
          ticking = true;
        }
      }, { passive: true });

      console.log('✨ Floating scroll feedback initialized');
    }

    // Initialize floating feedback
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupFloatingFeedback);
    } else {
      setupFloatingFeedback();
    }
    
    // Halloween Loading Animation (only on 2025/10/31)
    function initHalloweenAnimation() {
      const today = new Date();
      const isHalloween = today.getFullYear() === 2025 && 
                         today.getMonth() === 9 && // October is month 9 (0-indexed)
                         today.getDate() === 31;
      
      // Enhanced browser detection (including iPhone Safari)
      const isEdge = /Edge|Edg/i.test(navigator.userAgent);
      const isSafari = /Safari/i.test(navigator.userAgent) && !/Chrome|CriOS|Edge|Edg/i.test(navigator.userAgent);
      const isIPhone = /iPhone/i.test(navigator.userAgent);
      const isIPhoneSafari = isIPhone && isSafari;
      const isMobileEdge = isEdge && (/Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent) || window.innerWidth <= 768);
      
      console.log('🎃 Halloween check:', {
        date: today.toDateString(),
        isHalloween,
        year: today.getFullYear(),
        month: today.getMonth(),
        day: today.getDate(),
        userAgent: navigator.userAgent,
        screenSize: window.innerWidth + 'x' + window.innerHeight,
        isEdge: isEdge,
        isMobileEdge: isMobileEdge,
        isSafari: isSafari,
        isIPhone: isIPhone,
        isIPhoneSafari: isIPhoneSafari
      });
      
      if (isHalloween) {
        const halloweenLoader = document.getElementById('halloweenLoader');
        const mainContent = document.getElementById('mainContent');
        const halloweenEmojis = document.querySelectorAll('.halloween-emoji');
        const centerText = document.querySelector('.halloween-center-text');
        
        console.log('🎃 Halloween elements found:', {
          loader: !!halloweenLoader,
          content: !!mainContent,
          emojis: halloweenEmojis.length,
          text: !!centerText,
          browser: isIPhoneSafari ? 'iPhone Safari' : (isEdge ? (isMobileEdge ? 'Mobile Edge' : 'Desktop Edge') : (isSafari ? 'Safari' : 'Other'))
        });
        
        // Show Halloween loader with Edge-specific handling
        document.body.classList.add('halloween-active');
        halloweenLoader.classList.add('active');
        
        // Force display and background for Edge
        halloweenLoader.style.display = 'block';
        halloweenLoader.style.visibility = 'visible';
        halloweenLoader.style.zIndex = '9999';
        halloweenLoader.style.position = 'fixed';
        halloweenLoader.style.top = '0';
        halloweenLoader.style.left = '0';
        halloweenLoader.style.width = '100vw';
        halloweenLoader.style.height = '100vh';
        
        // Enhanced background fix for all browsers including iPhone Safari
        if (isEdge) {
          halloweenLoader.style.background = '#1a1a2e';
          halloweenLoader.style.backgroundColor = '#1a1a2e';
          console.log('🎃', isMobileEdge ? 'Mobile Edge' : 'Desktop Edge', 'browser detected - applied background fix');
        } else if (isIPhoneSafari) {
          // iPhone Safari specific optimizations
          halloweenLoader.style.background = '-webkit-linear-gradient(135deg, #1a1a2e, #16213e, #0f3460)';
          halloweenLoader.style.backgroundColor = '#1a1a2e';
          halloweenLoader.style.webkitBackgroundSize = '100% 100%';
          halloweenLoader.style.webkitOverflowScrolling = 'touch';
          console.log('🎃 iPhone Safari detected - applied webkit optimizations');
        } else if (isSafari) {
          // General Safari optimizations
          halloweenLoader.style.background = '-webkit-linear-gradient(135deg, #1a1a2e, #16213e, #0f3460)';
          console.log('🎃 Safari browser detected - applied webkit background');
        }
        
        // Set emoji content with iPhone Safari specific handling
        halloweenEmojis.forEach((emoji, index) => {
          const emojiChar = emoji.getAttribute('data-emoji');
          emoji.textContent = emojiChar;
          emoji.innerHTML = emojiChar; // Fallback for Edge
          
          // Force initial positioning with iPhone Safari optimizations
          emoji.style.position = 'absolute';
          emoji.style.zIndex = '10000';
          emoji.style.fontSize = '0px';
          emoji.style.opacity = '0';
          
          // iPhone Safari specific fixes
          if (isIPhoneSafari) {
            emoji.style.webkitTransform = 'translate3d(0,0,0)';
            emoji.style.webkitBackfaceVisibility = 'hidden';
            emoji.style.webkitPerspective = '1000px';
            emoji.style.webkitTextSizeAdjust = 'none';
          }
          
          console.log(`🎃 Emoji ${index}:`, emojiChar, emoji.textContent);
        });
        
        console.log('🎃 Halloween animation started on', 
          isIPhoneSafari ? 'iPhone Safari!' : 
          (isEdge ? (isMobileEdge ? 'Mobile Edge browser!' : 'Desktop Edge browser!') : 
          (isSafari ? 'Safari browser!' : 'browser!')));
        
        // Stage 1: Fly emojis from corners to center (0.8s)
        setTimeout(() => {
          console.log('🎃 Stage 1: Flying emojis to center');
          
          halloweenEmojis.forEach((emoji, index) => {
            setTimeout(() => {
              emoji.classList.add('fly-in');
              console.log(`🎃 Emoji ${index} flying in`);
              
              // Force style for Edge, Safari, and mobile compatibility
              const isMobile = window.innerWidth <= 768;
              const fontSize = isMobile ? '50px' : '60px';
              
              emoji.style.fontSize = fontSize;
              emoji.style.opacity = '1';
              emoji.style.top = '50%';
              emoji.style.left = '50%';
              emoji.style.right = 'auto';
              emoji.style.bottom = 'auto';
              emoji.style.position = 'absolute';
              emoji.style.zIndex = '10000';
              
              // Browser-specific transform handling
              if (isIPhoneSafari) {
                emoji.style.webkitTransform = 'translate(-50%, -50%) translate3d(0,0,0)';
                emoji.style.transform = 'translate(-50%, -50%)';
                emoji.style.webkitBackfaceVisibility = 'hidden';
              } else if (isEdge) {
                emoji.style.transform = 'translate(-50%, -50%)';
                emoji.style.msTransform = 'translate(-50%, -50%)';
                emoji.style.webkitTransform = 'translate(-50%, -50%)';
              } else if (isSafari) {
                emoji.style.webkitTransform = 'translate(-50%, -50%)';
                emoji.style.transform = 'translate(-50%, -50%)';
              } else {
                emoji.style.transform = 'translate(-50%, -50%)';
                emoji.style.webkitTransform = 'translate(-50%, -50%)';
              }
            }, index * 150); // Stagger the animations
          });
        }, 500);
        
        // Stage 2: Show center text (1.5s after start)
        setTimeout(() => {
          console.log('🎃 Stage 2: Showing center text');
          centerText.classList.add('show');
          centerText.style.opacity = '1';
        }, 1500);
        
        // Stage 3: Move emojis back to corners (2.5s after start)
        setTimeout(() => {
          console.log('🎃 Stage 3: Moving emojis back to corners');
          halloweenEmojis.forEach((emoji, index) => {
            emoji.classList.add('move-to-corner');
            const corner = emoji.getAttribute('data-corner');
            
            // Set specific corner positions with iPhone Safari, Edge and mobile compatibility
            switch(corner) {
              case 'top-left':
                emoji.style.top = '0px';
                emoji.style.left = '0px';
                emoji.style.right = 'auto';
                emoji.style.bottom = 'auto';
                if (isIPhoneSafari) {
                  emoji.style.webkitTransform = 'translate(0%, 0%) translate3d(0,0,0)';
                  emoji.style.transform = 'translate(0%, 0%)';
                } else {
                  emoji.style.transform = 'translate(0%, 0%)';
                  emoji.style.webkitTransform = 'translate(0%, 0%)';
                  if (isEdge) emoji.style.msTransform = 'translate(0%, 0%)';
                }
                break;
              case 'top-right':
                emoji.style.top = '0px';
                emoji.style.right = '0px';
                emoji.style.left = 'auto';
                emoji.style.bottom = 'auto';
                if (isIPhoneSafari) {
                  emoji.style.webkitTransform = 'translate(0%, 0%) translate3d(0,0,0)';
                  emoji.style.transform = 'translate(0%, 0%)';
                } else {
                  emoji.style.transform = 'translate(0%, 0%)';
                  emoji.style.webkitTransform = 'translate(0%, 0%)';
                  if (isEdge) emoji.style.msTransform = 'translate(0%, 0%)';
                }
                break;
              case 'bottom-left':
                emoji.style.bottom = '0px';
                emoji.style.left = '0px';
                emoji.style.top = 'auto';
                emoji.style.right = 'auto';
                if (isIPhoneSafari) {
                  emoji.style.webkitTransform = 'translate(0%, 0%) translate3d(0,0,0)';
                  emoji.style.transform = 'translate(0%, 0%)';
                } else {
                  emoji.style.transform = 'translate(0%, 0%)';
                  emoji.style.webkitTransform = 'translate(0%, 0%)';
                  if (isEdge) emoji.style.msTransform = 'translate(0%, 0%)';
                }
                break;
              case 'bottom-right':
                emoji.style.bottom = '0px';
                emoji.style.right = '0px';
                emoji.style.top = 'auto';
                emoji.style.left = 'auto';
                if (isIPhoneSafari) {
                  emoji.style.webkitTransform = 'translate(0%, 0%) translate3d(0,0,0)';
                  emoji.style.transform = 'translate(0%, 0%)';
                } else {
                  emoji.style.transform = 'translate(0%, 0%)';
                  emoji.style.webkitTransform = 'translate(0%, 0%)';
                  if (isEdge) emoji.style.msTransform = 'translate(0%, 0%)';
                }
                break;
              case 'center-left':
                emoji.style.top = '50%';
                emoji.style.left = '0px';
                emoji.style.right = 'auto';
                emoji.style.bottom = 'auto';
                if (isIPhoneSafari) {
                  emoji.style.webkitTransform = 'translate(0%, -50%) translate3d(0,0,0)';
                  emoji.style.transform = 'translate(0%, -50%)';
                } else {
                  emoji.style.transform = 'translate(0%, -50%)';
                  emoji.style.webkitTransform = 'translate(0%, -50%)';
                  if (isEdge) emoji.style.msTransform = 'translate(0%, -50%)';
                }
                break;
              case 'center-right':
                emoji.style.top = '50%';
                emoji.style.right = '0px';
                emoji.style.left = 'auto';
                emoji.style.bottom = 'auto';
                if (isIPhoneSafari) {
                  emoji.style.webkitTransform = 'translate(0%, -50%) translate3d(0,0,0)';
                  emoji.style.transform = 'translate(0%, -50%)';
                } else {
                  emoji.style.transform = 'translate(0%, -50%)';
                  emoji.style.webkitTransform = 'translate(0%, -50%)';
                  if (isEdge) emoji.style.msTransform = 'translate(0%, -50%)';
                }
                break;
            }
            console.log(`🎃 Emoji ${index} (${corner}) moved to corner`);
          });
        }, 2500);
        
        // Stage 4: Enlarge emojis to giant size (4s after start)
        setTimeout(() => {
          console.log('🎃 Stage 4: Enlarging emojis to giant size');
          halloweenEmojis.forEach((emoji, index) => {
            emoji.classList.add('enlarge-giant');
            // Force giant size for mobile, Edge, and iPhone Safari compatibility
            const isMobile = window.innerWidth <= 768;
            const giantSize = isMobile ? '500px' : '600px';
            emoji.style.fontSize = giantSize;
            emoji.style.opacity = '0.8';
            
            // Ensure transforms are applied for all browsers including iPhone Safari
            const currentTransform = emoji.style.transform;
            if (isIPhoneSafari) {
              emoji.style.webkitTransform = currentTransform + ' translate3d(0,0,0)';
              emoji.style.webkitBackfaceVisibility = 'hidden';
            } else {
              emoji.style.webkitTransform = currentTransform;
              if (isEdge) {
                emoji.style.msTransform = currentTransform;
              }
            }
            
            console.log(`🎃 Emoji ${index} enlarged to giant size: ${giantSize} (Mobile: ${isMobile}, iPhone Safari: ${isIPhoneSafari}, Edge: ${isEdge})`);
          });
        }, 4000);
        
        // Stage 5: Fade out and show main content (6.5s total)
        setTimeout(() => {
          console.log('🎃 Stage 5: Fading out Halloween, showing main content');
          halloweenLoader.classList.add('fade-out');
          mainContent.classList.add('show');
          
          // Remove Halloween loader after fade completes
          setTimeout(() => {
            document.body.classList.remove('halloween-active');
            if (halloweenLoader) {
              halloweenLoader.remove();
            }
            console.log('🎃 Halloween animation completed and cleaned up');
          }, 800);
        }, 6500);
      } else {
        console.log('🎃 Not Halloween 2025 - skipping animation');
      }
    }
    
    // Initialize Halloween animation on page load
    initHalloweenAnimation();
  </script>
</body>
</html>
</html>